```{r include = FALSE}
child_setup <- file.path("../basic/00setup.Rmd")
child_close <- file.path("../basic/01close.Rmd")

if (!exists("is_readme")) {
  printMapView <- function(mapviewObj, name, output = TRUE, delay = 0.2, full = FALSE) {
    mapviewObj
  }
} else {
  library(chromote)
  chromeSession <- ChromoteSession$new(width = 800, height = 800)


  printMapView <- function(mapviewObj, name, output = TRUE, delay = 5, full = FALSE, width = "500") {
    html_temp <- tempfile(fileext = ".html")
    if (inherits(mapviewObj, "mapview")) {
      htmlwidgets::saveWidget(mapviewObj@map, html_temp)
    } else if (inherits(mapviewObj, "htmlwidget")) {
      htmlwidgets::saveWidget(mapviewObj, html_temp)
    } else {
      stop("printMapView don't know how to handle this!")
    }

    chromeSession$Page$navigate(html_temp)

    Sys.sleep(delay)
    if (full == TRUE) {
      chromeSession$screenshot(name)
    } else {
      name <- gsub("\\.png$", "", name)
      full_path <- file.path("../..", gettextf("figure/%s.png", name))

      chromeSession$screenshot(full_path)
    }
    if (output == TRUE) {
      if (width != "") {
        width <- gettextf("width=%s ", width)
      }

      result <- knitr::asis_output(gettextf('<img src="figure/%s.png" %s/>\n', name, width))
      return(result)
    }
  }
}
```

## Introduction

In this section, we will demonstrate how to use the
`ATL03_ATL08_segment_create` function from the `ICESat2VegR` package. 
This function is used to compute segment IDs for ICESat-2 `ATL03` and `ATL08`
data and create segments based on a specified segment length.

```{r child=child_setup}
```

```{r, eval = FALSE}
# Herein as we are working with list of h5 files we will need
# to loop over each file and extract the attributes and then
# concatenate them with rbindlist2
atl03_atl08_dts <- list()

for (ii in seq_along(atl03_h5)) {
  atl03_file <- atl03_h5[[ii]]
  atl08_file <- atl08_h5[[ii]]

  atl03_atl08_dts[[ii]] <- ATL03_ATL08_photons_attributes_dt_join(
    atl03_file,
    atl08_file
  )
}

atl03_atl08_dt <- rbindlist2(atl03_atl08_dts)

head(atl03_atl08_dt)
```


## Create Segments IDs

Now, we use the `ATL03_ATL08_segment_create` function to create segments with a specified segment length.


```{r}
atl03_atl08_photons_grouped_dt <- ATL03_ATL08_segment_create(atl03_atl08_dt,
  segment_length = 30,
  centroid = "mean",
  output = NA,
  overwrite = FALSE
)
```

## Compute Segment Statistics
```{r, results = 'hide'}
atl03_atl08_seg_dt <- ATL03_ATL08_compute_seg_attributes_dt_segStat(
  atl03_atl08_photons_grouped_dt,
  list(
    h_canopy_ge0 = quantile(ph_h, 0.98),
    h_canopy_gt0 = quantile(ph_h[ph_h > 0], 0.98),
    n_ground = sum(classed_pc_flag == 1),
    n_mid_canopy = sum(classed_pc_flag == 2),
    n_top_canopy = sum(classed_pc_flag == 3),
    n_canopy_total = sum(classed_pc_flag >= 2)
  ),
  ph_class = c(1, 2, 3)
)

head(atl03_atl08_seg_dt)
```

<div align="center" style="overflow-x: scroll;">

```{r echo = FALSE, results = 'asis'}
print(head(atl03_atl08_seg_dt))
```

</div>


## Convert to SpatVector

Now, we convert the data.table to a SpatVector object.

```{r}
atl03_atl08_vect <- to_vect(atl03_atl08_seg_dt)
```

## Visualize the segments

Finally, we visualize the SpatVector interactively using mapview.


```{r, eval = FALSE}
mapview::mapview(atl03_atl08_vect)
```

<div align="center">

```{r, echo = FALSE, fig.cap = "Leaflet preview for segments h_canopy", out.height='400', out.width='500', fig.align = "center"}
if (requireNamespace("mapview")) {
  printMapView(mapview::mapview(atl03_atl08_vect), "atl03_atl08_vect", output = TRUE, delay = 5)
}
```

</div>


```{r child=child_close}
```