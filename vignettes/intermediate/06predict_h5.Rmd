```{r include = FALSE}
child_setup <- file.path("../basic/00setup.Rmd")
child_close <- file.path("../basic/01close.Rmd")

if (!exists("do_close")) {
  do_close <- FALSE
}
```


```{r child=child_setup}
```


## Creating a simple model for ATL08 data

Here, we will create a simple model to predict the canopy openness of ATL08 data based on the height of the canopy. 
We will use the `randomForest` package to create the model.

Let's assume we will fit the model on a subset of the ATL08 data and then predict the canopy openness for the rest of the data.

```{r, message = FALSE}
# Extract atl08 data from the first file
atl08_seg_dt <- ATL08_seg_attributes_dt(atl08_h5[[1]], attributes = c("h_canopy", "canopy_openness"))

# Avoid the weird NA values
atl08_seg_dt[h_canopy > 100, h_canopy := NA_real_]
atl08_seg_dt[is.na(h_canopy), canopy_openness := NA_real_]
atl08_seg_dt <- na.omit(atl08_seg_dt)

training <- sample(atl08_seg_dt, method = randomSampling(0.7))

# For the sake of the example, we will train and test the model with the same data
library(randomForest)
model <- randomForest::randomForest(canopy_openness ~ h_canopy, atl08_seg_dt)
```

## Predicting ATL08 data

Now we will predict the data for the entire ATL08 dataset, this can be
as large as you want. This will create or append the predicted values to an H5 file.

```{r}
out_h5 <- tempfile(fileext = ".h5")

for (atl08_h5_item in atl08_h5) {
  atl08_seg_dt <- ATL08_seg_attributes_dt(atl08_h5_item, attributes = c("h_canopy", "canopy_openness"))
  atl08_seg_dt[h_canopy > 100, h_canopy := NA_real_]
  atl08_seg_dt[is.na(h_canopy), canopy_openness := NA_real_]
  atl08_seg_dt <- na.omit(atl08_seg_dt)
  predicted_h5 <- predict_h5(model, atl08_seg_dt, out_h5)
}
```

## Rasterizing the predicted data

```{r}
output_raster <- tempfile(fileext = ".tif")
x <- predicted_h5[['longitude']][]
y <- predicted_h5[['latitude']][]
bbox <- terra::ext(min(x), max(x), min(y), max(y))

res <- 0.005
rasterize_h5(predicted_h5, output_raster, bbox = bbox, res = res)
out_rast <- terra::rast(output_raster)
names(out_rast) = c("n", "mean", "sd", "min", "max")
terra::plot(out_rast)
```

```{r child=child_close}
```


