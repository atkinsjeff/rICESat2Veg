% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/rasterize_h5.R
\name{rasterize_h5}
\alias{rasterize_h5}
\title{Rasterizes the model prediction saved in the HDF5 file}
\usage{
rasterize_h5(h5_input, output, bbox, res, ...)
}
\arguments{
\item{h5_input}{The input HDF5 file path}

\item{output}{The output raster file path}

\item{bbox}{The bounding box of the raster}

\item{res}{The resolution of the raster}

\item{...}{Additional parameters (see details section)}
}
\description{
This is used after running the prediction using \code{\link[=predict_h5]{predict_h5()}}
function to rasterize and aggregate the prediction within raster cells.
By default it will calculate (n, mean, variance * (n - 1), min, max, sd)
in a single raster file with those 6 bands in that order.
You can modify this behavior by changing the \code{agg_function}, \code{agg_join}
and \code{finalizer} parameters, see details section.
}
\details{
This function will create five different aggregate statistics
(n, mean, variance, min, max).

Within \code{...} additional parameters we can use:

\code{agg_function}: is a formula which return a data.table with the
aggregate function to perform over the data.
The default is:

\if{html}{\out{<div class="sourceCode">}}\preformatted{~data.table(
    n = length(x),
    mean = mean(x,na.rm = TRUE),
    variance = var(x) * (length(x) - 1),
    min = min(x, na.rm=T),
    max = max(x, na.rm=T)
  )
}\if{html}{\out{</div>}}

\code{agg_join}:  is a function to merge two data.table aggregates
from the \code{agg_function}. Since the h5 files will be aggregated
in chunks to avoid memory overflow, the statistics from the
different chunks should have a function to merge them.

The default function is:

\if{html}{\out{<div class="sourceCode">}}\preformatted{function(x1, x2) \{
    combined = data.table()
    x1$n[is.na(x1$n)] = 0
    x1$mean[is.na(x1$mean)] = 0
    x1$variance[is.na(x1$variance)] = 0
    x1$max[is.na(x1$max)] = -Inf
    x1$min[is.na(x1$min)] = Inf

    combined$n = x1$n + x2$n

    delta = x2$mean - x1$mean
    delta2 = delta * delta

    combined$mean = (x1$n * x1$mean + x2$n * x2$mean) / combined$n
    combined$variance = x1$variance + x2$variance +
      delta2 * x1$n * x2$n / combined$n

    combined$min = pmin(x1$min, x2$min, na.rm=F)
    combined$max = pmax(x1$max, x2$max, na.rm=F)
    return(combined)
\}
}\if{html}{\out{</div>}}

\code{finalizer}: is a list of formulas to generate the final
rasters based on the intermediate statistics from the previous
functions. The default \code{finalizer} will calculate the \code{sd},
based on the \code{variance} and \code{n} values. It is defined as:

\if{html}{\out{<div class="sourceCode">}}\preformatted{list(
  sd = ~sqrt(variance/(n - 1)),
)
}\if{html}{\out{</div>}}
}
\examples{
atl08_path <- system.file(
  "extdata",
  "atl08_clip.h5",
  package = "ICESat2VegR"
)

atl08_h5 <- ATL08_read(atl08_path = atl08_path)
atl08_dt <- ATL08_seg_attributes_dt(atl08_h5)

xmin <- min(atl08_dt$longitude)
xmax <- max(atl08_dt$longitude)
ymin <- min(atl08_dt$latitude)
ymax <- max(atl08_dt$latitude)

linear_model <- stats::lm(h_canopy ~ canopy_openness, data = atl08_dt)
output_h5 <- tempfile(fileext = ".h5")
predicted_h5 <- predict_h5(linear_model, atl08_dt, output_h5)
output_raster <- tempfile(fileext = ".tif")

rasterize_h5(
  predicted_h5,
  output = output_raster,
  bbox = terra::ext(xmin, xmax, ymin, ymax),
  res = 0.003
)

}
